<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="I recently got locked out of a server because of configuration mistake and had to rescue a FreeBSD server by netbooting Ubuntu (only image provided by the host that booted). My root was running on UFS">
<meta name="keywords" content="linux,kernel">
<meta property="og:type" content="article">
<meta property="og:title" content="Compiling a single linux kernel module with matching vermagic">
<meta property="og:url" content="http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/index.html">
<meta property="og:site_name" content="stty.io">
<meta property="og:description" content="I recently got locked out of a server because of configuration mistake and had to rescue a FreeBSD server by netbooting Ubuntu (only image provided by the host that booted). My root was running on UFS">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-06-02T10:06:05.335Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Compiling a single linux kernel module with matching vermagic">
<meta name="twitter:description" content="I recently got locked out of a server because of configuration mistake and had to rescue a FreeBSD server by netbooting Ubuntu (only image provided by the host that booted). My root was running on UFS">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Compiling a single linux kernel module with matching vermagic</title>
    <!-- styles -->
    <link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/lib/meslo-LG/styles.css">
    <link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
    <!-- jquery -->
    <script src="/lib/jquery/jquery.min.js"></script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/spaghetti-">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2018/06/02/ezjail-and-network-interfaces/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&text=Compiling a single linux kernel module with matching vermagic"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&title=Compiling a single linux kernel module with matching vermagic"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&is_video=false&description=Compiling a single linux kernel module with matching vermagic"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Compiling a single linux kernel module with matching vermagic&body=Check out this article: http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&title=Compiling a single linux kernel module with matching vermagic"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&title=Compiling a single linux kernel module with matching vermagic"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&title=Compiling a single linux kernel module with matching vermagic"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&title=Compiling a single linux kernel module with matching vermagic"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&name=Compiling a single linux kernel module with matching vermagic&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Compiling a single linux kernel module with matching vermagic
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">stty.io</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-06-02T09:46:46.000Z" itemprop="datePublished">2018-06-02</time>
    </div>


      
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/kernel/">kernel</a>, <a class="tag-link" href="/tags/linux/">linux</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>I recently got locked out of a server because of configuration mistake and had
to rescue a FreeBSD server by netbooting Ubuntu (only image provided by the host
that booted). My root was running on UFS and as expected Ubuntu does not come
with a write enabled UFS kernel module.</p>
<p>I set up a virtual build box on my local machine as it was faster than setting
everything up on the netboot’d image (plus since it was totally in memory, if
anything went wrong it’d be best to setup tooling offline). But just in case we
need to remember, the dependencies are </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">libncurses-dev</span><br><span class="line">libssl</span><br><span class="line">build-essentials</span><br><span class="line">bc</span><br></pre></td></tr></table></figure>
<p>After booting into the Ubuntu 16.04 image, we can then fetch the kernel source 
by doing</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get <span class="built_in">source</span> linux-image-`uname -r`</span><br></pre></td></tr></table></figure>
<p>This would install <code>/usr/src/linux-headers-version</code> (replace version) with the
kernel source. Then we need to scp the <code>Makefile</code> found in the directory to the
same directory on our build box.</p>
<p>We can then enable <code>UFS_FS_WRITE=y</code> in the kernel config. Then call</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">make oldconfig</span><br><span class="line">make prepare</span><br><span class="line">make modules_prepare</span><br><span class="line">make M=fs/ufs/ modules</span><br></pre></td></tr></table></figure>
<p>Then the resulting <code>ufs.ko</code> can be scp’d back to the server to be loaded. The
vermagic will match if the same <code>Makefile</code> was used across both kernel
compilations.</p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/spaghetti-">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&text=Compiling a single linux kernel module with matching vermagic"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&title=Compiling a single linux kernel module with matching vermagic"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&is_video=false&description=Compiling a single linux kernel module with matching vermagic"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Compiling a single linux kernel module with matching vermagic&body=Check out this article: http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&title=Compiling a single linux kernel module with matching vermagic"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&title=Compiling a single linux kernel module with matching vermagic"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&title=Compiling a single linux kernel module with matching vermagic"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&title=Compiling a single linux kernel module with matching vermagic"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://stty.io/2018/06/02/compiling-a-single-module-linux-kernel/&name=Compiling a single linux kernel module with matching vermagic&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 Alex
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/spaghetti-">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    <script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

<!-- Disqus Comments -->


</body>
</html>
